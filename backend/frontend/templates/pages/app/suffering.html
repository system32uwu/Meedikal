{% from "components/app/form-field.html" import formField with context %}

{% extends 'layouts/app-base.html' %}
{% block title %}{{'Create' if 'create' in request.endpoint else 'Update'}} {{sufferingType}}{% endblock %}

{% block pageContent %}
<div class="w-full px-6 lg:px-10 pt-4">
    <div class="shadow-xl p-4 space-y-2" id="suffering-fields">
        {% if suffering.get('ID', none) is not none %}
        {{formField("ID", suffering.get('ID', ''), true)}}
        {% endif %}
        {{formField("Name", suffering.get('name', ''))}}
        {{formField("Description", suffering.get('description', ''))}}
    </div>
    <div id="error-box" class="hidden">
        <p class="text-red-500 font-semibold"></p>
    </div>
    <div class="mb-4 mt-4 flex justify-between w-full space-x-10">
        <button onclick="window.location.href=window.location.href;" class="bg-red-500 w-full font-bold text-white text-center text-sm rounded-full py-2">
            Cancel
        </button>
        <button id="save" class="bg-turqoise w-full font-bold text-white text-center text-sm rounded-full py-2">
            Save
        </button>
    </div>
</div>
<script>
    let errorBox = document.getElementById('error-box');
    let errorText = errorBox.getElementsByTagName('p')[0];

    let suffering = {{suffering | tojson | safe}};
    let sufferingType = "{{sufferingType}}";
    let mode = "{{request.endpoint.rsplit('.')[2]}}".includes('create') ? 'CREATE' : 'UPDATE';

    document.getElementById('save').addEventListener('click', async () => {
        toggleLoadingModal();
        errorBox.classList.add("hidden");
        let res;

        if (mode === 'CREATE') {    
            let body = {
                name: document.getElementById('Name').value,
                description: document.getElementById('Description').value,
            }
            res = await fetch(`/api/suffering/${sufferingType}`, {
                method: 'POST',
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(body)
            });
        } else {    
            let body = {
                id: suffering.id,
                name: {
                    value: suffering.name,
                    newValue: document.getElementById('Name').value
                },
                description:{
                    value: suffering.description,
                    newValue: document.getElementById('Description').value
                }
            }

            res = await fetch(`/api/suffering/${sufferingType}`, {
                method: 'PUT',
                headers: {
                    Accept: "application/json",
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(body)
            });
        }

        const savedsuffering = await res.json();

        if (res.status !== 200) {
            errorText.textContent = savedsuffering.error;
            errorBox.classList.remove("hidden");
            toggleLoadingModal(true);
            return;
        } else {
            showOkModal();
        }
    })
</script>
{% endblock %}